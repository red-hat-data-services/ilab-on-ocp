FROM registry.access.redhat.com/ubi9/python-312:1@sha256:69aa8a11f6aef38aa5130c44ac94bad8a65e9641b7eaa0a44f04fd7decdf8be2

ARG SOURCE_CODE=.

# Default for ubi8/python
WORKDIR /opt/app-root/src/pipelines/distributed-ilab

COPY ${SOURCE_CODE} .

USER root

RUN echo "Installing Runtime Dependencies" && \
    dnf install -y skopeo && \
    if [[ $(uname -m) == "ppc64le" ]]; then \
    dnf install gcc-toolset-13 make && source /opt/rh/gcc-toolset-13/enable && \
    curl -L https://cmake.org/files/v3.31/cmake-3.31.0.tar.gz | tar xz && \
    cd cmake-3.31.0 && ./bootstrap && make && make install && cd .. && rm -rf cmake-3.31.0; \
    fi; \
    dnf clean all


RUN if [[ $(uname -m) == "ppc64le" ]]; then \
    pip install setuptools wheel && git clone --recurse-submodules https://github.com/googleapis/python-crc32c -b v1.7.1 && \
    cd  python-crc32c/google_crc32c && mkdir build && cd  build && \
    export CRC32C_INSTALL_PREFIX=/usr/local && /usr/local/bin/cmake   -DCMAKE_BUILD_TYPE=Release   -DCRC32C_BUILD_TESTS=no   -DCRC32C_BUILD_BENCHMARKS=no   -DBUILD_SHARED_LIBS=yes -DCMAKE_INSTALL_PREFIX=${CRC32C_INSTALL_PREFIX}   .. && \
    make all install && cd ../.. && \
    python setup.py build_ext --include-dirs=${CRC32C_INSTALL_PREFIX}/include --library-dirs=${CRC32C_INSTALL_PREFIX}/lib64 --rpath=${CRC32C_INSTALL_PREFIX}/lib64 bdist_wheel --dist-dir dist/ && \
    pip install dist/*.whl && cd .. && rm -rf python-crc32c; \
    fi; \
    pip install --no-cache-dir -r requirements.txt && \
    chgrp -R 0 . && \
    chmod -R g=u . && \
    mv mixtral-tokenizer /models

USER default

# Default for ubi8/python
WORKDIR /opt/app-root/src

LABEL name="odh-ml-pipelines-runtime-generic" \
    com.redhat.component="odh-ml-pipelines-runtime-generic-container" \
    summary="Generic runtime image for pipeline tasks with embedded managed pipelines." \
    description="Generic runtime image for pipeline tasks with embedded managed pipelines." \
    summary="odh-ml-pipelines-runtime-generic" \
    maintainer="['managed-open-data-hub@redhat.com']" \
    io.openshift.expose-services="" \
    io.k8s.display-name="odh-ml-pipelines-runtime-generic" \
    io.k8s.description="odh-ml-pipelines-runtime-generic"
